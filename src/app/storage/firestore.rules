rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return isSignedIn() && uid == request.auth.uid; }
    function isOwnerOnExisting() { return isSignedIn() && resource.data.ownerUid == request.auth.uid; }

    // Per-user root doc (profile / preferences)
    match /users/{uid} {
      allow read: if isOwner(uid);
      // On create, enforce ownership stamp
      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;
      allow update, delete: if isOwnerOnExisting();
    }

    // Sessions nested under a user: users/{uid}/sessions/{sessionId}
    match /users/{uid}/sessions/{sessionId} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid)
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.date is timestamp
        && request.resource.data.practiceTime is int
        && request.resource.data.practiceTime >= 0;
      allow update, delete: if isOwnerOnExisting();
    }

    // User-owned songs library
    match /users/{uid}/songs/{songId} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid)
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.artist is string;
      allow update, delete: if isOwnerOnExisting();
    }

    // Popular music lookup collections (read-only, seeded via admin SDK)
    match /popularArtists/{docId} {
      allow read: if isSignedIn();
    }

    match /popularAlbums/{docId} {
      allow read: if isSignedIn();
    }

    match /popularSongs/{docId} {
      allow read: if isSignedIn();
    }

    // Optional: user-owned documents metadata if you store file metadata in Firestore
    match /users/{uid}/documents/{docId} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid)
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.storagePath is string;
      allow update, delete: if isOwnerOnExisting();
    }
  }
}
